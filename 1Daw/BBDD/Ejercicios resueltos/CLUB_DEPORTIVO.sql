-- BASE DE DATOS CLUB_DEPORTIVO
-- 1º DAW
-- 22-03-2023
-- WALTER MARTIN LOPES
-- -------------------------------------------------------
CREATE DATABASE CLUB_DEPORTIVO;
USE CLUB_DEPORTIVO;

-- ===========================CREACION DE TABLAS=======================================
CREATE TABLE SOCIOS(
NUMERO INT ,
DOCUMENTO CHAR(8),
NOMBRE VARCHAR(30),
DOMICILIO VARCHAR(30),
PRIMARY KEY (NUMERO)
);
CREATE TABLE DEPORTES(
NOMBRE VARCHAR(15)PRIMARY KEY,
PROFESOR VARCHAR(30),
DIA VARCHAR(10),
CUOTA DECIMAL(5,2)
);
CREATE TABLE INSCRIPCIONES (
NUMEROSOCIO INT NOT NULL,
DEPORTE VARCHAR(15) NOT NULL,
CUOTAS INT,
PRIMARY KEY(NUMEROSOCIO,DEPORTE),
CONSTRAINT SOCIO_FK FOREIGN KEY (NUMEROSOCIO) REFERENCES SOCIOS (NUMERO),
CONSTRAINT DEPORTE_FK FOREIGN KEY (DEPORTE) REFERENCES DEPORTES(NOMBRE)
);

-- ===========================CARGA DE DATOS=======================================
INSERT INTO DEPORTES VALUES('TENIS','ANA LOPEZ','LUNES',20);
INSERT INTO DEPORTES VALUES('NATACION','ANA LOPEZ','MARTES',15);
INSERT INTO DEPORTES VALUES('FUTBOL','CARLOS FUENTES','MIERCOLES',10);
INSERT INTO DEPORTES VALUES('BASQUET','GASTON GARCIA','JUEVES',15);
INSERT INTO DEPORTES VALUES('PADEL','JUAN HUERTA','LUNES',15);
INSERT INTO DEPORTES VALUES('HANDBALL','JUAN HUERTA','MARTES',10);
INSERT INTO SOCIOS VALUES(1,'23333333','ALBERTO PAREDES','COLON 111');
INSERT INTO SOCIOS VALUES(2,'24444444','CARLOS CONTE','SARMIENTO 755');
INSERT INTO SOCIOS VALUES(3,'25555555','FABIAN FUENTES','CASEROS 987');
INSERT INTO SOCIOS VALUES(4,'26666666','HECTOR LOPEZ','SUCRE 344');
INSERT INTO INSCRIPCIONES VALUES(1,'TENIS',1);
INSERT INTO INSCRIPCIONES VALUES(1,'BASQUET',2);
INSERT INTO INSCRIPCIONES VALUES(1,'NATACION',1);
INSERT INTO INSCRIPCIONES VALUES(2,'TENIS',9);
INSERT INTO INSCRIPCIONES VALUES(2,'NATACION',1);
INSERT INTO INSCRIPCIONES VALUES(2,'BASQUET',DEFAULT);
INSERT INTO INSCRIPCIONES VALUES(2,'FUTBOL',2);
INSERT INTO INSCRIPCIONES VALUES(3,'TENIS',8);
INSERT INTO INSCRIPCIONES VALUES(3,'BASQUET',9);
INSERT INTO INSCRIPCIONES VALUES(3,'NATACION',0);
INSERT INTO INSCRIPCIONES VALUES(4,'BASQUET',10);

-- ===========================VISTAS=======================================
-- 1. Crea una vista en la que aparezca el nombre y la dirección de los socios. Mostrar el contenido de la vista.
CREATE VIEW NOM_DIR_SOCIOS AS 
SELECT NOMBRE,DOMICILIO FROM SOCIOS;

SELECT * FROM NOM_DIR_SOCIOS;

-- 2. Crea una vista en la que aparezcan el número del socio y las cuotas que lleva pagadas. Mostrar el contenido de la vista.
CREATE VIEW NUMSOCIO_CUOTAS AS
SELECT S.NUMERO AS NUMERO_SOCIO,SUM(I.CUOTAS) AS NUMERO_CUOTAS
FROM SOCIOS AS S INNER JOIN INSCRIPCIONES AS I
ON S.NUMERO=I.NUMEROSOCIO
GROUP BY S.NUMERO;

SELECT * FROM NUMSOCIO_CUOTAS;

-- 3. Crea una vista en la que aparezca el nombre del deporte y el día que se da clase. Mostrar el contenido de la vista.
CREATE VIEW CALENDARIO AS
SELECT NOMBRE,DIA FROM DEPORTES;

SELECT * FROM CALENDARIO;

-- 4. Crea una vista en la que aparezca el nombre del profesor y la cuota para cada deporte. Mostrar el contenido de la vista.
CREATE VIEW TARIFAS AS
SELECT PROFESOR,CUOTA FROM DEPORTES;

SELECT * FROM TARIFAS;

-- 5. Crea una vista que contenga el nombre y domicilio de los socios, el deporte que practica y las cuotas que lleva pagadas. Mostrar el contenido de la vista.
CREATE VIEW SOCIOS_DEPORTES AS
SELECT S.NOMBRE,S.DOMICILIO,I.DEPORTE,SUM(I.CUOTAS) AS NUMERO_CUOTAS
FROM SOCIOS AS S INNER JOIN INSCRIPCIONES AS I
ON S.NUMERO = I.NUMEROSOCIO
GROUP BY S.NOMBRE,S.DOMICILIO,I.DEPORTE;

SELECT * FROM SOCIOS_DEPORTES;
-- 6. Crea una vista en la que aparezca el nombre y documento del socio, el deporte, el día y el nombre del profesor. Mostrar el contenido de la vista.
CREATE VIEW VISTA6 AS
SELECT S.NOMBRE,S.DOCUMENTO,I.DEPORTE,D.DIA,D.PROFESOR 
FROM SOCIOS AS S INNER JOIN INSCRIPCIONES AS I
ON S.NUMERO = I.NUMEROSOCIO
INNER JOIN DEPORTES AS D
ON I.DEPORTE = D.NOMBRE;

SELECT * FROM VISTA6;

-- ===========================SUBCONSULTAS=======================================
-- 1. Socios inscritos en natación UTILIZANDO EXISTS
SELECT * FROM SOCIOS AS S
WHERE  EXISTS (
			SELECT *
            FROM INSCRIPCIONES AS I 
            WHERE S.NUMERO = I.NUMEROSOCIO
            AND DEPORTE = "NATACION");
            
-- 2. Socios no inscritos en natación UTILIZANDO NOT EXISTS
SELECT * FROM SOCIOS AS S
WHERE NOT EXISTS (
			SELECT *
            FROM INSCRIPCIONES AS I 
            WHERE S.NUMERO = I.NUMEROSOCIO
            AND DEPORTE = "NATACION");
            

-- 3. Socios que han pagado todas las cuotas
SELECT * FROM SOCIOS
WHERE NUMERO IN (
			SELECT NUMEROSOCIO FROM INSCRIPCIONES
            WHERE CUOTAS = 10);
            
-- 4. Profesores que imparten clases de más de un deporte CON SUBCONSULTA.
SELECT DISTINCT PROFESOR FROM DEPORTES
WHERE PROFESOR IN (
			SELECT PROFESOR FROM DEPORTES
            GROUP BY PROFESOR
            HAVING COUNT(NOMBRE)>1);

-- 5. La misma con inner join
SELECT DISTINCT D1.PROFESOR
FROM DEPORTES AS D1 INNER JOIN DEPORTES AS D2
ON D1.PROFESOR = D2.PROFESOR
WHERE D1.NOMBRE<>D2.NOMBRE;

-- 6. Deportes de los que hay clase los mismos días que de natación CON SUBCONSULTA.
SELECT * FROM DEPORTES 
WHERE DIA = (
		SELECT DIA FROM DEPORTES 
		WHERE NOMBRE = "NATACION")
AND NOMBRE != "NATACION";
 
-- 7. La misma con inner join.
SELECT D1.NOMBRE
FROM DEPORTES AS D1
INNER JOIN DEPORTES AS D2
ON D1.DIA=D2.DIA
WHERE D2.NOMBRE = "NATACION"
AND D1.NOMBRE<>D2.NOMBRE;
-- 8. Actualizar el número de cuotas pagadas por el socio 25555555. Ahora son 10 cuotas (utilizar subconsulta para hallar el número del socio que tiene el documento 25555555)
UPDATE INSCRIPCIONES
SET CUOTAS = 10
WHERE NUMEROSOCIO = (SELECT NUMERO 
					FROM SOCIOS 
                    WHERE DOCUMENTO= '25555555');

SELECT * FROM INSCRIPCIONES;

-- 9. Borrar INSCRIPCIONES DE socios que deben cuotas (son aquellos socios para los cuales el campo COUTAS tiene un valor distinto de 10. Utilizar una subconsulta para averiguar esos socios)
DELETE FROM INSCRIPCIONES
WHERE NUMEROSOCIO IN (
	SELECT * FROM(
				SELECT DISTINCT NUMEROSOCIO FROM INSCRIPCIONES
				WHERE CUOTAS != 10) AS TABLA);
                