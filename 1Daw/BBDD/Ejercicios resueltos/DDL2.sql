-- BASE DE DATOS DATOSALUMNOS
-- 1º DAW
-- 26-01-2023
-- WALTER MARTIN LOPES
-- -------------------------------------------------------
CREATE DATABASE DDL2;
USE DDL2;

-- 1 CREACION DE TABLAS
CREATE TABLE EMPLEADOS(
DNI CHAR(9),
NOMBRE VARCHAR(10),
APELLIDO1 VARCHAR(15),
APELLIDO2 VARCHAR(15),
DIRECC1 VARCHAR(25),
DIRECC2 VARCHAR(20),
CIUDAD VARCHAR(20),
PROVINCIA VARCHAR(20),
COD_POSTAL CHAR(5),
SEXO CHAR(1),
FECHA_NAC DATE);

CREATE TABLE ESTUDIOS(
EMPLEADO_DNI CHAR(9),
UNIVERSIDAD INT,
AÑO INT,
GRADO VARCHAR(3),
ESPECIALIDAD VARCHAR(20));

CREATE TABLE UNIVERSIDADES(
COD_UNIV INT,
NOMBRE_UNIV VARCHAR(25),
CIUDAD VARCHAR(20),
MUNICIPIO VARCHAR(2),
COD_POSTAL CHAR(5));

CREATE TABLE TRABAJOS(
COD_TRABAJO INT,
NOMBRE_TRAB VARCHAR(20),
SALARIO_MIN DECIMAL(10,2),
SALARIO_MAX DECIMAL(10,2));

CREATE TABLE DEPARTAMENTOS(
COD_DPTO INT,
NOMBRE_DPTO VARCHAR(30),
DPTO_PADRE INT,
PRESUPUESTO DECIMAL(10,2),
PRES_ACTUAL DECIMAL(10,2));

CREATE TABLE HISTORIAL_LABORAL(
DNI_EMPLEADO CHAR(9),
COD_TRABAJO INT,
FECHA_INICIO DATE,
FECHA_FIN DATE,
COD_DPTO INT,
DNI_SUPERVISOR INT);

CREATE TABLE HISTORIAL_SALARIAL(
DNI_EMPLEADO CHAR(9),
SALARIO DECIMAL(10,2),
FECHA_COMIENZO DATE,
FECHA_FIN DATE);

-- 2 RESTRICCIONES --------------------------
-- A--
ALTER TABLE EMPLEADOS
MODIFY APELLIDO1 VARCHAR(15) NOT NULL,
MODIFY NOMBRE VARCHAR(10) NOT NULL;

DESC EMPLEADOS;

ALTER TABLE UNIVERSIDADES
MODIFY NOMBRE_UNIV VARCHAR(25) NOT NULL;

DESC UNIVERSIDADES;

ALTER TABLE TRABAJOS 
MODIFY NOMBRE_TRAB VARCHAR(20) NOT NULL,
MODIFY SALARIO_MIN DECIMAL(10,2) NOT NULL,
MODIFY SALARIO_MAX DECIMAL(10,2) NOT NULL;

DESC TRABAJOS;

ALTER TABLE DEPARTAMENTOS
MODIFY NOMBRE_DPTO VARCHAR(30) NOT NULL,
MODIFY PRESUPUESTO DECIMAL(10,2) NOT NULL;

DESC DEPARTAMENTOS;

-- B--

ALTER TABLE EMPLEADOS
ADD CONSTRAINT HM CHECK (SEXO IN('H','M'));

ALTER TABLE DEPARTAMENTOS
MODIFY NOMBRE_DPTO VARCHAR(30) NOT NULL UNIQUE;

ALTER TABLE TRABAJOS 
MODIFY NOMBRE_TRAB VARCHAR(20) NOT NULL UNIQUE;
-- --------------------------------------------

-- 3 PRIMARY KEY Y FK --------------------------

ALTER TABLE EMPLEADOS
ADD CONSTRAINT DNI_PK PRIMARY KEY (DNI);

DESC EMPLEADOS;

ALTER TABLE DEPARTAMENTOS
ADD CONSTRAINT COD_DPTO_PK PRIMARY KEY (COD_DPTO);

ALTER TABLE DEPARTAMENTOS
ADD CONSTRAINT DPTO_PADRE_FK FOREIGN KEY (DPTO_PADRE) REFERENCES DEPARTAMENTOS (COD_DPTO) ON UPDATE CASCADE ON DELETE CASCADE;

ALTER TABLE ESTUDIOS
ADD CONSTRAINT DUE_PK PRIMARY KEY (EMPLEADO_DNI,UNIVERSIDAD,ESPECIALIDAD);

ALTER TABLE ESTUDIOS
ADD CONSTRAINT EMP_DNI_FK FOREIGN KEY(EMPLEADO_DNI) REFERENCES EMPLEADOS(DNI) ON UPDATE CASCADE ON DELETE CASCADE;

ALTER TABLE UNIVERSIDADES
ADD CONSTRAINT COD_UNIV_PK PRIMARY KEY (COD_UNIV);

ALTER TABLE ESTUDIOS
ADD CONSTRAINT UNIV_FK FOREIGN KEY(UNIVERSIDAD) REFERENCES UNIVERSIDADES(COD_UNIV) ON UPDATE CASCADE ON DELETE CASCADE;

ALTER TABLE TRABAJOS
ADD  CONSTRAINT COD_TRABAJO_PK PRIMARY KEY(COD_TRABAJO);

ALTER TABLE HISTORIAL_LABORAL
ADD CONSTRAINT DCF_PK PRIMARY KEY(DNI_EMPLEADO,COD_TRABAJO,FECHA_INICIO);

-- MODIFICO LA COLUMNA DNI_SUPERVISOR DE LA TABLA HISTORIAL LABORAL PARA PODER HACER LA FK
ALTER TABLE HISTORIAL_LABORAL
MODIFY DNI_SUPERVISOR CHAR(9);

ALTER TABLE HISTORIAL_LABORAL
ADD CONSTRAINT DNI_EMP_FK FOREIGN KEY(DNI_EMPLEADO) REFERENCES EMPLEADOS(DNI) ON UPDATE CASCADE ON DELETE CASCADE,
ADD CONSTRAINT DNI_SUP_FK FOREIGN KEY(DNI_SUPERVISOR) REFERENCES EMPLEADOS(DNI) ON UPDATE CASCADE ON DELETE CASCADE,
ADD CONSTRAINT COD_TRAB_FK FOREIGN KEY(COD_TRABAJO) REFERENCES TRABAJOS(COD_TRABAJO) ON UPDATE CASCADE ON DELETE CASCADE,
ADD CONSTRAINT COD_DPTO_FK FOREIGN KEY(COD_DPTO) REFERENCES DEPARTAMENTOS(COD_DPTO) ON UPDATE CASCADE ON DELETE CASCADE;

ALTER TABLE HISTORIAL_SALARIAL
ADD CONSTRAINT DSF_PK PRIMARY KEY(DNI_EMPLEADO,SALARIO,FECHA_COMIENZO);

ALTER TABLE HISTORIAL_SALARIAL
ADD CONSTRAINT D_EMP_FK FOREIGN KEY(DNI_EMPLEADO) REFERENCES EMPLEADOS(DNI) ON UPDATE CASCADE ON DELETE CASCADE;

DESC HISTORIAL_SALARIAL;

-- 5 INSERTO DATOS -------------------------------
-- A
INSERT INTO EMPLEADOS VALUES 
("23456789A", "Juan", "Pérez", "García", "Calle Falsa 123", "Apto. 4B", "Madrid", "Madrid", "28100", "H", "1980-05-20"),
("87654321B", "María", "Rodríguez", "Sánchez", "Calle Falsa 456", "Apto. 3C", "Barcelona", "Cataluña", "08011", "M", "1985-12-15");

SELECT * FROM EMPLEADOS;

INSERT INTO ESTUDIOS VALUES 
("23456789A", 1, 2010, "Lic", "Informática"),
("87654321B", 2, 2012, "Ing", "Finanzas");

SELECT * FROM ESTUDIOS;

INSERT INTO UNIVERSIDADES VALUES 
(1, "Universidad de Madrid", "Madrid", "MA", "28100"),
(2, "Universidad de Barcelona", "Barcelona", "BA", "08011");

SELECT * FROM UNIVERSIDADES;

INSERT INTO TRABAJOS VALUES 
(1, "Programador", 3000.00, 6000.00),
(2, "Contador", 4000.00, 8000.00);

SELECT * FROM TRABAJOS;

INSERT INTO DEPARTAMENTOS VALUES 
(1, "Departamento de Tecnología", NULL, 100000.00, 80000.00),
(2, "Departamento de Finanzas", 1, 50000.00, 40000.00);

SELECT * FROM DEPARTAMENTOS;

INSERT INTO HISTORIAL_LABORAL VALUES 
("23456789A", 1, "2020-01-01", "2022-12-31", 1, "87654321B"),
("87654321B", 2, "2019-01-01", "2022-12-31", 2, "23456789A");

SELECT * FROM HISTORIAL_LABORAL;

INSERT INTO HISTORIAL_SALARIAL VALUES 
("23456789A", 30000.00, "2020-01-01", "2022-12-31"),
("87654321B", 35000.00, "2019-01-01", "2022-12-31");

SELECT * FROM HISTORIAL_SALARIAL;

-- B
INSERT INTO EMPLEADOS (NOMBRE,APELLIDO1,APELLIDO2,DNI,SEXO)
VALUES ("Sergio","Palma","Entrena",111222,"H"),
	   ("Lucia","Ortega","Plus",222333,"M");
       
-- 6 AÑADIR NUEVA COLUMNA
ALTER TABLE EMPLEADOS
ADD COLUMN VALORACION INT CHECK(VALORACION BETWEEN 1 AND 10 ) DEFAULT '5' AFTER APELLIDO2;

SELECT * FROM EMPLEADOS;

-- 7 ELIMINAR RESTRICCION NOT NULL DEL ATRIBUTO NOMBRE
ALTER TABLE EMPLEADOS
MODIFY NOMBRE VARCHAR(10);

DESC EMPLEADOS;

-- 8 MODIFICAR A VARCHAR(40) LA DIREC1 DE EMPLEADOS
ALTER TABLE EMPLEADOS 
MODIFY DIRECC1 VARCHAR(40);

-- 9 BORRAR UNA UNIVERSIDAD
DELETE FROM UNIVERSIDADES
WHERE COD_UNIV = 2;

SELECT * FROM UNIVERSIDADES;

SELECT * FROM ESTUDIOS;